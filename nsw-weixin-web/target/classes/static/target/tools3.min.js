!function(e,t,r){function i(e){function t(e,t,r){var n={chunks:"slice_blob",jpgresize:"send_binary_string",pngresize:"send_binary_string",progress:"report_upload_progress",multi_selection:"select_multiple",dragdrop:"drag_and_drop",drop_element:"drag_and_drop",headers:"send_custom_headers",canSendBinary:"send_binary",triggerDialog:"summon_file_dialog"};n[e]?i[n[e]]=t:r||(i[e]=t)}var r=e.required_features,i={};return"string"==typeof r?s.each(r.split(/\s*,\s*/),function(e){t(e,!0)}):"object"==typeof r?s.each(r,function(e,r){t(r,e)}):r===!0&&(e.multipart||(i.send_binary_string=!0),e.chunk_size>0&&(i.slice_blob=!0),e.resize.enabled&&(i.send_binary_string=!0),s.each(e,function(e,r){t(r,!!e,!0)})),i}var n=e.setTimeout,a={},s={VERSION:"2.1.1",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,FILE_DUPLICATE_ERROR:-602,IMAGE_FORMAT_ERROR:-700,IMAGE_MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,mimeTypes:t.mimes,ua:t.ua,typeOf:t.typeOf,extend:t.extend,guid:t.guid,get:function(e){var r,i=[];"array"!==t.typeOf(e)&&(e=[e]);for(var n=e.length;n--;)r=t.get(e[n]),r&&i.push(r);return i.length?i:null},each:t.each,getPos:t.getPos,getSize:t.getSize,xmlEncode:function(e){var t={"<":"lt",">":"gt","&":"amp",'"':"quot","'":"#39"},r=/[<>&\"\']/g;return e?(""+e).replace(r,function(e){return t[e]?"&"+t[e]+";":e}):e},toArray:t.toArray,inArray:t.inArray,addI18n:t.addI18n,translate:t.translate,isEmptyObj:t.isEmptyObj,hasClass:t.hasClass,addClass:t.addClass,removeClass:t.removeClass,getStyle:t.getStyle,addEvent:t.addEvent,removeEvent:t.removeEvent,removeAllEvents:t.removeAllEvents,cleanName:function(e){var t,r;for(r=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"],t=0;t<r.length;t+=2)e=e.replace(r[t],r[t+1]);return e=e.replace(/\s+/g,"_"),e=e.replace(/[^a-z0-9_\-\.]+/gi,"")},buildUrl:function(e,t){var r="";return s.each(t,function(e,t){r+=(r?"&":"")+encodeURIComponent(t)+"="+encodeURIComponent(e)}),r&&(e+=(e.indexOf("?")>0?"&":"?")+r),e},formatSize:function(e){function t(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)}if(e===r||/\D/.test(e))return s.translate("N/A");var i=Math.pow(1024,4);return e>i?t(e/i,1)+" "+s.translate("tb"):e>(i/=1024)?t(e/i,1)+" "+s.translate("gb"):e>(i/=1024)?t(e/i,1)+" "+s.translate("mb"):e>1024?Math.round(e/1024)+" "+s.translate("kb"):e+" "+s.translate("b")},parseSize:t.parseSizeStr,predictRuntime:function(e,r){var i,n;return i=new s.Uploader(e),n=t.Runtime.thatCan(i.getOption().required_features,r||e.runtimes),i.destroy(),n},addFileFilter:function(e,t){a[e]=t}};s.addFileFilter("mime_types",function(e,t,r){e.length&&!e.regexp.test(t.name)?(this.trigger("Error",{code:s.FILE_EXTENSION_ERROR,message:s.translate("File extension error."),file:t}),r(!1)):r(!0)}),s.addFileFilter("max_file_size",function(e,t,r){var i;e=s.parseSize(e),t.size!==i&&e&&t.size>e?(this.trigger("Error",{code:s.FILE_SIZE_ERROR,message:s.translate("File size error."),file:t}),r(!1)):r(!0)}),s.addFileFilter("prevent_duplicates",function(e,t,r){if(e)for(var i=this.files.length;i--;)if(t.name===this.files[i].name&&t.size===this.files[i].size)return this.trigger("Error",{code:s.FILE_DUPLICATE_ERROR,message:s.translate("Duplicate file error."),file:t}),void r(!1);r(!0)}),s.Uploader=function(e){function o(){var e,t,r=0;if(this.state==s.STARTED){for(t=0;t<T.length;t++)e||T[t].status!=s.QUEUED?r++:(e=T[t],this.trigger("BeforeUpload",e)&&(e.status=s.UPLOADING,this.trigger("UploadFile",e)));r==T.length&&(this.state!==s.STOPPED&&(this.state=s.STOPPED,this.trigger("StateChanged")),this.trigger("UploadComplete",T))}}function u(e){e.percent=e.size>0?Math.ceil(e.loaded/e.size*100):100,l()}function l(){var e,t;for(S.reset(),e=0;e<T.length;e++)t=T[e],t.size!==r?(S.size+=t.origSize,S.loaded+=t.loaded*t.origSize/t.size):S.size=r,t.status==s.DONE?S.uploaded++:t.status==s.FAILED?S.failed++:S.queued++;S.size===r?S.percent=T.length>0?Math.ceil(S.uploaded/T.length*100):0:(S.bytesPerSec=Math.ceil(S.loaded/((+new Date-O||1)/1e3)),S.percent=S.size>0?Math.ceil(S.loaded/S.size*100):0)}function d(){var e=A[0]||F[0];return!!e&&e.getRuntime().uid}function g(e,r){if(e.ruid){var i=t.Runtime.getInfo(e.ruid);if(i)return i.can(r)}return!1}function c(){this.bind("FilesAdded",m),this.bind("CancelUpload",y),this.bind("BeforeUpload",_),this.bind("UploadFile",v),this.bind("UploadProgress",b),this.bind("StateChanged",E),this.bind("QueueChanged",l),this.bind("Error",R),this.bind("FileUploaded",k),this.bind("Destroy",w)}function f(e,r){var i=this,n=0,a=[],o={accept:e.filters.mime_types,runtime_order:e.runtimes,required_caps:e.required_features,preferred_caps:I,swf_url:e.flash_swf_url,xap_url:e.silverlight_xap_url};s.each(e.runtimes.split(/\s*,\s*/),function(t){e[t]&&(o[t]=e[t])}),e.browse_button&&s.each(e.browse_button,function(r){a.push(function(a){var u=new t.FileInput(s.extend({},o,{name:e.file_data_name,multiple:e.multi_selection,container:e.container,browse_button:r}));u.onready=function(){var e=t.Runtime.getInfo(this.ruid);t.extend(i.features,{chunks:e.can("slice_blob"),multipart:e.can("send_multipart"),multi_selection:e.can("select_multiple")}),n++,A.push(this),a()},u.onchange=function(){i.addFile(this.files)},u.bind("mouseenter mouseleave mousedown mouseup",function(i){q||(e.browse_button_hover&&("mouseenter"===i.type?t.addClass(r,e.browse_button_hover):"mouseleave"===i.type&&t.removeClass(r,e.browse_button_hover)),e.browse_button_active&&("mousedown"===i.type?t.addClass(r,e.browse_button_active):"mouseup"===i.type&&t.removeClass(r,e.browse_button_active)))}),u.bind("error runtimeerror",function(){u=null,a()}),u.init()})}),e.drop_element&&s.each(e.drop_element,function(e){a.push(function(r){var a=new t.FileDrop(s.extend({},o,{drop_zone:e}));a.onready=function(){var e=t.Runtime.getInfo(this.ruid);i.features.dragdrop=e.can("drag_and_drop"),n++,F.push(this),r()},a.ondrop=function(){i.addFile(this.files)},a.bind("error runtimeerror",function(){a=null,r()}),a.init()})}),t.inSeries(a,function(){"function"==typeof r&&r(n)})}function p(e,r,i){var n=new t.Image;try{n.onload=function(){n.downsize(r.width,r.height,r.crop,r.preserve_headers)},n.onresize=function(){i(this.getAsBlob(e.type,r.quality)),this.destroy()},n.onerror=function(){i(e)},n.load(e)}catch(a){i(e)}}function h(e,r,n){function a(e,t,r){var i=U[e];switch(e){case"max_file_size":"max_file_size"===e&&(U.max_file_size=U.filters.max_file_size=t);break;case"chunk_size":(t=s.parseSize(t))&&(U[e]=t);break;case"filters":"array"===s.typeOf(t)&&(t={mime_types:t}),r?s.extend(U.filters,t):U.filters=t,t.mime_types&&(U.filters.mime_types.regexp=function(e){var t=[];return s.each(e,function(e){s.each(e.extensions.split(/,/),function(e){/^\s*\*\s*$/.test(e)?t.push("\\.*"):t.push("\\."+e.replace(new RegExp("["+"/^$.*+?|()[]{}\\".replace(/./g,"\\$&")+"]","g"),"\\$&"))})}),new RegExp("("+t.join("|")+")$","i")}(U.filters.mime_types));break;case"resize":r?s.extend(U.resize,t,{enabled:!0}):U.resize=t;break;case"prevent_duplicates":U.prevent_duplicates=U.filters.prevent_duplicates=!!t;break;case"browse_button":case"drop_element":t=s.get(t);case"container":case"runtimes":case"multi_selection":case"flash_swf_url":case"silverlight_xap_url":U[e]=t,r||(u=!0);break;default:U[e]=t}r||o.trigger("OptionChanged",e,t,i)}var o=this,u=!1;"object"==typeof e?s.each(e,function(e,t){a(t,e,n)}):a(e,r,n),n?(U.required_features=i(s.extend({},U)),I=i(s.extend({},U,{required_features:!0}))):u&&(o.trigger("Destroy"),f.call(o,U,function(e){e?(o.runtime=t.Runtime.getInfo(d()).type,o.trigger("Init",{runtime:o.runtime}),o.trigger("PostInit")):o.trigger("Error",{code:s.INIT_ERROR,message:s.translate("Init error.")})}))}function m(e,t){[].push.apply(T,t),e.trigger("QueueChanged"),e.refresh()}function _(e,t){if(U.unique_names){var r=t.name.match(/\.([^.]+)$/),i="part";r&&(i=r[1]),t.target_name=t.id+"."+i}}function v(e,r){function i(){d-- >0?n(a,1e3):(r.loaded=f,e.trigger("Error",{code:s.HTTP_ERROR,message:s.translate("HTTP Error."),file:r,response:x.responseText,status:x.status,responseHeaders:x.getAllResponseHeaders()}))}function a(){var g,p,h,m;r.status!=s.DONE&&r.status!=s.FAILED&&e.state!=s.STOPPED&&(h={name:r.target_name||r.name},l&&c.chunks&&o.size>l?(m=Math.min(l,o.size-f),g=o.slice(f,f+m)):(m=o.size,g=o),l&&c.chunks&&(e.settings.send_chunk_number?(h.chunk=Math.ceil(f/l),h.chunks=Math.ceil(o.size/l)):(h.offset=f,h.total=o.size)),x=new t.XMLHttpRequest,x.upload&&(x.upload.onprogress=function(t){r.loaded=Math.min(r.size,f+t.loaded),e.trigger("UploadProgress",r)}),x.onload=function(){return x.status>=400?void i():(d=e.settings.max_retries,m<o.size?(g.destroy(),f+=m,r.loaded=Math.min(f,o.size),e.trigger("ChunkUploaded",r,{offset:r.loaded,total:o.size,response:x.responseText,status:x.status,responseHeaders:x.getAllResponseHeaders()}),"Android Browser"===t.Env.browser&&e.trigger("UploadProgress",r)):r.loaded=r.size,g=p=null,void(!f||f>=o.size?(r.size!=r.origSize&&(o.destroy(),o=null),e.trigger("UploadProgress",r),r.status=s.DONE,e.trigger("FileUploaded",r,{response:x.responseText,status:x.status,responseHeaders:x.getAllResponseHeaders()})):n(a,1)))},x.onerror=function(){i()},x.onloadend=function(){this.destroy(),x=null},e.settings.multipart&&c.multipart?(h.name=r.target_name||r.name,x.open("post",u,!0),s.each(e.settings.headers,function(e,t){x.setRequestHeader(t,e)}),p=new t.FormData,s.each(s.extend(h,e.settings.multipart_params),function(e,t){p.append(t,e)}),p.append(e.settings.file_data_name,g),x.send(p,{runtime_order:e.settings.runtimes,required_caps:e.settings.required_features,preferred_caps:I,swf_url:e.settings.flash_swf_url,xap_url:e.settings.silverlight_xap_url})):(u=s.buildUrl(e.settings.url,s.extend(h,e.settings.multipart_params)),x.open("post",u,!0),x.setRequestHeader("Content-Type","application/octet-stream"),s.each(e.settings.headers,function(e,t){x.setRequestHeader(t,e)}),x.send(g,{runtime_order:e.settings.runtimes,required_caps:e.settings.required_features,preferred_caps:I,swf_url:e.settings.flash_swf_url,xap_url:e.settings.silverlight_xap_url})))}var o,u=e.settings.url,l=e.settings.chunk_size,d=e.settings.max_retries,c=e.features,f=0;r.loaded&&(f=r.loaded=l*Math.floor(r.loaded/l)),o=r.getSource(),e.settings.resize.enabled&&g(o,"send_binary_string")&&~t.inArray(o.type,["image/jpeg","image/png"])?p.call(this,o,e.settings.resize,function(e){o=e,r.size=e.size,a()}):a()}function b(e,t){u(t)}function E(e){if(e.state==s.STARTED)O=+new Date;else if(e.state==s.STOPPED)for(var t=e.files.length-1;t>=0;t--)e.files[t].status==s.UPLOADING&&(e.files[t].status=s.QUEUED,l())}function y(){x&&x.abort()}function k(e){l(),n(function(){o.call(e)},1)}function R(e,t){t.file&&(t.file.status=s.FAILED,u(t.file),e.state==s.STARTED&&(e.trigger("CancelUpload"),n(function(){o.call(e)},1)))}function w(e){e.stop(),s.each(T,function(e){e.destroy()}),T=[],A.length&&(s.each(A,function(e){e.destroy()}),A=[]),F.length&&(s.each(F,function(e){e.destroy()}),F=[]),I={},q=!1,O=x=null,S.reset()}var U,O,S,x,z=s.guid(),T=[],I={},A=[],F=[],q=!1;U={runtimes:t.Runtime.order,max_retries:0,chunk_size:0,multipart:!0,multi_selection:!0,file_data_name:"file",flash_swf_url:"js/Moxie.swf",silverlight_xap_url:"js/Moxie.xap",filters:{mime_types:[],prevent_duplicates:!1,max_file_size:0},resize:{enabled:!1,preserve_headers:!0,crop:!1},send_chunk_number:!0},h.call(this,e,null,!0),S=new s.QueueProgress,s.extend(this,{id:z,uid:z,state:s.STOPPED,features:{},runtime:null,files:T,settings:U,total:S,init:function(){var e=this;return"function"==typeof U.preinit?U.preinit(e):s.each(U.preinit,function(t,r){e.bind(r,t)}),U.browse_button&&U.url?(c.call(this),void f.call(this,U,function(r){"function"==typeof U.init?U.init(e):s.each(U.init,function(t,r){e.bind(r,t)}),r?(e.runtime=t.Runtime.getInfo(d()).type,e.trigger("Init",{runtime:e.runtime}),e.trigger("PostInit")):e.trigger("Error",{code:s.INIT_ERROR,message:s.translate("Init error.")})})):void this.trigger("Error",{code:s.INIT_ERROR,message:s.translate("Init error.")})},setOption:function(e,t){h.call(this,e,t,!this.runtime)},getOption:function(e){return e?U[e]:U},refresh:function(){A.length&&s.each(A,function(e){e.trigger("Refresh")}),this.trigger("Refresh")},start:function(){this.state!=s.STARTED&&(this.state=s.STARTED,this.trigger("StateChanged"),o.call(this))},stop:function(){this.state!=s.STOPPED&&(this.state=s.STOPPED,this.trigger("StateChanged"),this.trigger("CancelUpload"))},disableBrowse:function(){q=arguments[0]===r||arguments[0],A.length&&s.each(A,function(e){e.disable(q)}),this.trigger("DisableBrowse",q)},getFile:function(e){var t;for(t=T.length-1;t>=0;t--)if(T[t].id===e)return T[t]},addFile:function(e,r){function i(e,r){var i=[];t.each(l.settings.filters,function(t,r){a[r]&&i.push(function(i){a[r].call(l,t,e,function(e){i(!e)})})}),t.inSeries(i,r)}function o(e){var a=t.typeOf(e);if(e instanceof t.File){if(!e.ruid&&!e.isDetached()){if(!u)return!1;e.ruid=u,e.connectRuntime(u)}o(new s.File(e))}else e instanceof t.Blob?(o(e.getSource()),e.destroy()):e instanceof s.File?(r&&(e.name=r),g.push(function(t){i(e,function(r){r||(c.push(e),l.trigger("FileFiltered",e)),n(t,1)})})):t.inArray(a,["file","blob"])!==-1?o(new t.File(null,e)):"node"===a&&"filelist"===t.typeOf(e.files)?t.each(e.files,o):"array"===a&&(r=null,t.each(e,o))}var u,l=this,g=[],c=[];u=d(),o(e),g.length&&t.inSeries(g,function(){c.length&&l.trigger("FilesAdded",c)})},removeFile:function(e){for(var t="string"==typeof e?e:e.id,r=T.length-1;r>=0;r--)if(T[r].id===t)return this.splice(r,1)[0]},splice:function(e,t){var i=T.splice(e===r?0:e,t===r?T.length:t),n=!1;return this.state==s.STARTED&&(n=!0,this.stop()),this.trigger("FilesRemoved",i),s.each(i,function(e){e.destroy()}),this.trigger("QueueChanged"),this.refresh(),n&&this.start(),i},bind:function(e,t,r){var i=this;s.Uploader.prototype.bind.call(this,e,function(){var e=[].slice.call(arguments);return e.splice(0,1,i),t.apply(this,e)},0,r)},destroy:function(){this.trigger("Destroy"),U=S=null,this.unbindAll()}})},s.Uploader.prototype=t.EventTarget.instance,s.File=function(){function e(e){s.extend(this,{id:s.guid(),name:e.name||e.fileName,type:e.type||"",size:e.size||e.fileSize,origSize:e.size||e.fileSize,loaded:0,percent:0,status:s.QUEUED,lastModifiedDate:e.lastModifiedDate||(new Date).toLocaleString(),getNative:function(){var e=this.getSource().getSource();return t.inArray(t.typeOf(e),["blob","file"])!==-1?e:null},getSource:function(){return r[this.id]?r[this.id]:null},destroy:function(){var e=this.getSource();e&&(e.destroy(),delete r[this.id])}}),r[this.id]=e}var r={};return e}(),s.QueueProgress=function(){var e=this;e.size=0,e.loaded=0,e.uploaded=0,e.failed=0,e.queued=0,e.percent=0,e.bytesPerSec=0,e.reset=function(){e.size=e.loaded=e.uploaded=e.failed=e.queued=e.percent=e.bytesPerSec=0}},e.plupload=s}(window,mOxie),plupload.addI18n({"Stop Upload":"停止上传","Upload URL might be wrong or doesn't exist.":"上传的URL可能是错误的或不存在。",tb:"tb",Size:"大小",Close:"关闭","Init error.":"初始化错误。","Add files to the upload queue and click the start button.":"将文件添加到上传队列，然后点击”开始上传“按钮。",Filename:"文件名","Image format either wrong or not supported.":"图片格式错误或者不支持。",Status:"状态","HTTP Error.":"HTTP 错误。","Start Upload":"开始上传",mb:"mb",kb:"kb","Duplicate file error.":"重复文件错误。","File size error.":"文件大小错误。","N/A":"N/A",gb:"gb","Error: Invalid file extension:":"错误：无效的文件扩展名:","Select files":"选择文件","%s already present in the queue.":"%s 已经在当前队列里。","File: %s":"文件: %s",b:"b","Uploaded %d/%d files":"已上传 %d/%d 个文件","Upload element accepts only %d file(s) at a time. Extra files were stripped.":"每次只接受同时上传 %d 个文件，多余的文件将会被删除。","%d files queued":"%d 个文件加入到队列","File: %s, size: %d, max file size: %d":"文件: %s, 大小: %d, 最大文件大小: %d","Drag files here.":"把文件拖到这里。","Runtime ran out of available memory.":"运行时已消耗所有可用内存。","File count error.":"文件数量错误。","File extension error.":"文件扩展名错误。","Error: File too large:":"错误: 文件太大:","Add Files":"增加文件"}),function(global){function createCookie(e,t,r){var i=new Date;i.setTime(i.getTime()+24*r*60*60*1e3);var n="; expires="+i.toGMTString();document.cookie=e+"="+t+n+"; path=/"}function readCookie(e){for(var t=e+"=",r=document.cookie.split(";"),i=0,n=r.length;i<n;i++){for(var a=r[i];" "===a.charAt(0);)a=a.substring(1,a.length);if(0===a.indexOf(t))return a.substring(t.length,a.length)}return null}function QiniuJsSDK(){function log(e,t){for(var r="[qiniu-js-sdk]["+e+"]",i=r,n=0;n<t.length;n++)i+="string"==typeof t[n]?" "+t[n]:" "+that.stringifyJSON(t[n]);that.detectIEVersion()?console.log(i):(t.unshift(r),console.log.apply(console,t)),document.getElementById("qiniu-js-sdk-log")&&(document.getElementById("qiniu-js-sdk-log").innerHTML+="<p>"+i+"</p>")}function makeLogFunc(e){var t=e.toLowerCase();logger[t]=function(){if(window.console&&window.console.log&&logger.level>=logger[e]){var r=Array.prototype.slice.call(arguments);log(t,r)}}}var that=this;this.detectIEVersion=function(){for(var e=4,t=document.createElement("div"),r=t.getElementsByTagName("i");t.innerHTML="<!--[if gt IE "+e+"]><i></i><![endif]-->",r[0];)e++;return e>4&&e};var logger={MUTE:0,FATA:1,ERROR:2,WARN:3,INFO:4,DEBUG:5,TRACE:6,level:0};for(var property in logger)logger.hasOwnProperty(property)&&"number"==typeof logger[property]&&!logger.hasOwnProperty(property.toLowerCase())&&makeLogFunc(property);var qiniuUploadUrl;qiniuUploadUrl="https:"===window.location.protocol?"https://up.qbox.me":"http://upload.qiniu.com";var qiniuUploadUrls=["http://upload.qiniu.com","http://up.qiniu.com"],changeUrlTimes=0;this.resetUploadUrl=function(){if("https:"===window.location.protocol)qiniuUploadUrl="https://up.qbox.me";else{var e=changeUrlTimes%qiniuUploadUrls.length;qiniuUploadUrl=qiniuUploadUrls[e],changeUrlTimes++}logger.debug("resetUploadUrl: "+qiniuUploadUrl)},this.resetUploadUrl(),this.isImage=function(e){return e=e.split(/[?#]/)[0],/\.(png|jpg|jpeg|gif|bmp)$/i.test(e)},this.getFileExtension=function(e){var t,r=e.split(".");return t=1===r.length||""===r[0]&&2===r.length?"":r.pop().toLowerCase()},this.utf8_encode=function(e){if(null===e||"undefined"==typeof e)return"";var t,r,i=e+"",n="",a=0;t=r=0,a=i.length;for(var s=0;s<a;s++){var o=i.charCodeAt(s),u=null;if(o<128)r++;else if(o>127&&o<2048)u=String.fromCharCode(o>>6|192,63&o|128);else if(63488&o^!0)u=String.fromCharCode(o>>12|224,o>>6&63|128,63&o|128);else{if(64512&o^!0)throw new RangeError("Unmatched trail surrogate at "+s);var l=i.charCodeAt(++s);if(64512&l^!0)throw new RangeError("Unmatched lead surrogate at "+(s-1));o=((1023&o)<<10)+(1023&l)+65536,u=String.fromCharCode(o>>18|240,o>>12&63|128,o>>6&63|128,63&o|128)}null!==u&&(r>t&&(n+=i.slice(t,r)),n+=u,t=r=s+1)}return r>t&&(n+=i.slice(t,a)),n},this.base64_encode=function(e){var t,r,i,n,a,s,o,u,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",d=0,g=0,c="",f=[];if(!e)return e;e=this.utf8_encode(e+"");do t=e.charCodeAt(d++),r=e.charCodeAt(d++),i=e.charCodeAt(d++),u=t<<16|r<<8|i,n=u>>18&63,a=u>>12&63,s=u>>6&63,o=63&u,f[g++]=l.charAt(n)+l.charAt(a)+l.charAt(s)+l.charAt(o);while(d<e.length);switch(c=f.join(""),e.length%3){case 1:c=c.slice(0,-2)+"==";break;case 2:c=c.slice(0,-1)+"="}return c},this.URLSafeBase64Encode=function(e){return e=this.base64_encode(e),e.replace(/\//g,"_").replace(/\+/g,"-")},this.createAjax=function(e){var t={};return t=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},this.parseJSON=function(data){if(window.JSON&&window.JSON.parse)return window.JSON.parse(data);var rx_dangerous=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,text=String(data);return rx_dangerous.lastIndex=0,rx_dangerous.test(text)&&(text=text.replace(rx_dangerous,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})),eval("("+text+")")},this.stringifyJSON=function(e){if(window.JSON&&window.JSON.stringify)return window.JSON.stringify(e);switch(typeof e){case"string":return'"'+e.replace(/(["\\])/g,"\\$1")+'"';case"array":return"["+e.map(that.stringifyJSON).join(",")+"]";case"object":if(e instanceof Array){for(var t=[],r=e.length,i=0;i<r;i++)t.push(that.stringifyJSON(e[i]));return"["+t.join(",")+"]"}if(null===e)return"null";var n=[];for(var a in e)e.hasOwnProperty(a)&&n.push(that.stringifyJSON(a)+":"+that.stringifyJSON(e[a]));return"{"+n.join(",")+"}";case"number":return e;case!1:return e;case"boolean":return e}},this.trim=function(e){return null===e?"":e.replace(/^\s+|\s+$/g,"")},this.uploader=function(e){var t=function(){var t,r,i,n=that.detectIEVersion(),a="Safari"===mOxie.Env.browser&&mOxie.Env.version<=5&&"Windows"===mOxie.Env.os&&"7"===mOxie.Env.osVersion||"Safari"===mOxie.Env.browser&&"iOS"===mOxie.Env.os&&"7"===mOxie.Env.osVersion;n&&n<9&&e.chunk_size&&e.runtimes.indexOf("flash")>=0?e.chunk_size=0:a?e.chunk_size=0:(t=20,r=4<<t,i=plupload.parseSize(e.chunk_size),i>r&&(e.chunk_size=r))},r=function(t){if(e.uptoken)return void(that.token=e.uptoken);{if(!e.uptoken_url)return e.uptoken_func?(logger.debug("get uptoken from uptoken_func"),that.token=e.uptoken_func(t),void logger.debug("get new uptoken: ",that.token)):void logger.error("one of [uptoken, uptoken_url, uptoken_func] settings in options is required!");logger.debug("get uptoken from: ",that.uptoken_url);var r=that.createAjax();if(r.open("GET",that.uptoken_url,!1),r.setRequestHeader("If-Modified-Since","0"),r.send(),200===r.status){var i=that.parseJSON(r.responseText);that.token=i.uptoken,logger.debug("get new uptoken: ",i.uptoken)}else logger.error("get uptoken error: ",r.responseText)}},i=function(t,r,i){var n="",a=!1;if(!e.save_key)if(a=t.getOption&&t.getOption("unique_names"),a=a||t.settings&&t.settings.unique_names){var s=that.getFileExtension(r.name);n=s?r.id+"."+s:r.id}else n="function"==typeof i?i(t,r):r.name;return n};if(e.log_level&&(logger.level=e.log_level),!e.domain)throw"domain setting in options is required!";if(!e.browse_button)throw"browse_button setting in options is required!";if(!e.uptoken&&!e.uptoken_url&&!e.uptoken_func)throw"one of [uptoken, uptoken_url, uptoken_func] settings in options is required!";logger.debug("init uploader start"),logger.debug("environment: ",mOxie.Env),logger.debug("userAgent: ",navigator.userAgent);var n={},a=e.init&&e.init.Error,s=e.init&&e.init.FileUploaded;e.init.Error=function(){},e.init.FileUploaded=function(){},that.uptoken_url=e.uptoken_url,that.token="",that.key_handler="function"==typeof e.init.Key?e.init.Key:"",this.domain=e.domain;var o="",u={isResumeUpload:!1,resumeFilesize:0,startTime:"",currentTime:""};t(),logger.debug("invoke reset_chunk_size()"),logger.debug("op.chunk_size: ",e.chunk_size),plupload.extend(n,e,{url:qiniuUploadUrl,multipart_params:{token:""}}),logger.debug("option: ",n);var l=new plupload.Uploader(n);logger.debug("new plupload.Uploader(option)"),l.bind("Init",function(t,i){logger.debug("Init event activated"),e.get_new_uptoken||r(null)}),logger.debug("bind Init event"),l.bind("FilesAdded",function(e,t){logger.debug("FilesAdded event activated");var r=e.getOption&&e.getOption("auto_start");r=r||e.settings&&e.settings.auto_start,logger.debug("auto_start: ",r),logger.debug("files: ",t);var i=function(){return"ios"===mOxie.Env.OS.toLowerCase()};if(i())for(var n=0;n<t.length;n++){var a=t[n],s=that.getFileExtension(a.name);a.name=a.id+"."+s}r&&setTimeout(function(){e.start(),logger.debug("invoke up.start()")},0),e.refresh()}),logger.debug("bind FilesAdded event"),l.bind("BeforeUpload",function(t,n){logger.debug("BeforeUpload event activated"),n.speed=n.speed||0,o="",e.get_new_uptoken&&r(n);var a=function(t,r,n){u.startTime=(new Date).getTime();var a;a=e.save_key?{token:that.token}:{key:i(t,r,n),token:that.token},logger.debug("directUpload multipart_params_obj: ",a);var o=e.x_vars;if(void 0!==o&&"object"==typeof o)for(var l in o)o.hasOwnProperty(l)&&("function"==typeof o[l]?a["x:"+l]=o[l](t,r):"object"!=typeof o[l]&&(a["x:"+l]=o[l]));t.setOption({url:qiniuUploadUrl,multipart:!0,chunk_size:s()?e.max_file_size:void 0,multipart_params:a})},s=function(){var e=navigator.userAgent.toLowerCase();return!(!e.match(/MicroMessenger/i)&&"QQBrowser"!==mOxie.Env.browser&&!e.match(/V1_AND_SQ/i)||"android"!==mOxie.Env.OS.toLowerCase())},d=t.getOption&&t.getOption("chunk_size");if(d=d||t.settings&&t.settings.chunk_size,logger.debug("uploader.runtime: ",l.runtime),logger.debug("chunk_size: ",d),"html5"!==l.runtime&&"flash"!==l.runtime||!d)logger.debug("directUpload because uploader.runtime !== 'html5' || uploader.runtime !== 'flash' || !chunk_size"),a(t,n,that.key_handler);else if(n.size<d||s())logger.debug("directUpload because file.size < chunk_size || is_android_weixin_or_qq()"),a(t,n,that.key_handler);else{var g=localStorage.getItem(n.name),c=d;if(g){g=that.parseJSON(g);var f=(new Date).getTime(),p=g.time||0,h=864e5;f-p<h&&100!==g.percent&&n.size===g.total?(n.percent=g.percent,n.loaded=g.offset,o=g.ctx,u.isResumeUpload=!0,u.resumeFilesize=g.offset,g.offset+c>n.size&&(c=n.size-g.offset)):localStorage.removeItem(n.name)}u.startTime=(new Date).getTime(),t.setOption({url:qiniuUploadUrl+"/mkblk/"+c,multipart:!1,chunk_size:d,required_features:"chunks",headers:{Authorization:"UpToken "+that.token},multipart_params:{}})}}),logger.debug("bind BeforeUpload event"),l.bind("UploadProgress",function(e,t){logger.trace("UploadProgress event activated"),u.currentTime=(new Date).getTime();var r=u.currentTime-u.startTime,i=t.loaded||0;u.isResumeUpload&&(i=t.loaded-u.resumeFilesize),t.speed=(i/r*1e3).toFixed(0)||0}),logger.debug("bind UploadProgress event"),l.bind("ChunkUploaded",function(e,t,r){logger.debug("ChunkUploaded event activated"),logger.debug("file: ",t),logger.debug("info: ",r);var i=that.parseJSON(r.response);logger.debug("res: ",i),o=o?o+","+i.ctx:i.ctx;var n=r.total-r.offset,a=e.getOption&&e.getOption("chunk_size");a=a||e.settings&&e.settings.chunk_size,n<a&&(e.setOption({url:qiniuUploadUrl+"/mkblk/"+n}),logger.debug("up.setOption url: ",qiniuUploadUrl+"/mkblk/"+n)),localStorage.setItem(t.name,that.stringifyJSON({ctx:o,percent:t.percent,total:r.total,offset:r.offset,time:(new Date).getTime()}))}),logger.debug("bind ChunkUploaded event");var d=qiniuUploadUrls.length,g=function(e){return d-- >0?(setTimeout(function(){that.resetUploadUrl(),e.status=plupload.QUEUED,l.stop(),l.start()},0),!0):(d=qiniuUploadUrls.length,!1)};return l.bind("Error",function(e){return function(t,r){logger.error("Error event activated"),logger.error("err: ",r);var i="",n=r.file;if(n){switch(r.code){case plupload.FAILED:i="上传失败。请稍后再试。";break;case plupload.FILE_SIZE_ERROR:var a=t.getOption&&t.getOption("max_file_size");a=a||t.settings&&t.settings.max_file_size,i="浏览器最大可上传"+a+"。更大文件请使用命令行工具。";break;case plupload.FILE_EXTENSION_ERROR:i="文件验证失败。请稍后重试。";break;case plupload.HTTP_ERROR:if(""===r.response){if(i=r.message||"未知网络错误。",!g(n))return;break}var s=that.parseJSON(r.response),o=s.error;switch(r.status){case 400:i="请求报文格式错误。";break;case 401:i="客户端认证授权失败。请重试或提交反馈。";break;case 405:i="客户端请求错误。请重试或提交反馈。";break;case 579:i="资源上传成功，但回调失败。";break;case 599:if(i="网络连接异常。请重试或提交反馈。",!g(n))return;break;case 614:i="文件已存在。";try{s=that.parseJSON(s.error),o=s.error||"file exists"}catch(u){o=s.error||"file exists"}break;case 631:i="指定空间不存在。";break;case 701:i="上传数据块校验出错。请重试或提交反馈。";break;default:if(i="未知错误。",!g(n))return}i=i+"("+r.status+"："+o+")";break;case plupload.SECURITY_ERROR:i="安全配置错误。请联系网站管理员。";break;case plupload.GENERIC_ERROR:i="上传失败。请稍后再试。";break;case plupload.IO_ERROR:i="上传失败。请稍后再试。";break;case plupload.INIT_ERROR:i="网站配置错误。请联系网站管理员。",l.destroy();break;default:if(i=r.message+r.details,!g(n))return}e&&e(t,r,i)}t.refresh()}}(a)),logger.debug("bind Error event"),l.bind("FileUploaded",function(t){return function(r,n,a){logger.debug("FileUploaded event activated"),logger.debug("file: ",n),logger.debug("info: ",a);var s=function(r,i,n){if(e.downtoken_url){var a=that.createAjax();a.open("POST",e.downtoken_url,!0),a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.onreadystatechange=function(){if(4===a.readyState)if(200===a.status){var e;try{e=that.parseJSON(a.responseText)}catch(s){throw"invalid json format"}var o={};plupload.extend(o,that.parseJSON(n),e),t&&t(r,i,that.stringifyJSON(o))}else l.trigger("Error",{status:a.status,response:a.responseText,file:i,code:plupload.HTTP_ERROR})},a.send("key="+that.parseJSON(n).key+"&domain="+e.domain)}else t&&t(r,i,n)},u=that.parseJSON(a.response);if(o=o?o:u.ctx,logger.debug("ctx: ",o),o){var d="";logger.debug("save_key: ",e.save_key),e.save_key||(d=i(r,n,that.key_handler),d=d?"/key/"+that.URLSafeBase64Encode(d):"");var g="/fname/"+that.URLSafeBase64Encode(n.name);logger.debug("op.x_vars: ",e.x_vars);var c=e.x_vars,f="",p="";if(void 0!==c&&"object"==typeof c)for(var h in c)c.hasOwnProperty(h)&&("function"==typeof c[h]?f=that.URLSafeBase64Encode(c[h](r,n)):"object"!=typeof c[h]&&(f=that.URLSafeBase64Encode(c[h])),p+="/x:"+h+"/"+f);var m,_=qiniuUploadUrl+"/mkfile/"+n.size+d+g+p,v=that.detectIEVersion();v&&v<=9?(m=new mOxie.XMLHttpRequest,mOxie.Env.swf_url=e.flash_swf_url):m=that.createAjax(),m.open("POST",_,!0),m.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),m.setRequestHeader("Authorization","UpToken "+that.token);var b=function(){if(logger.debug("ajax.readyState: ",m.readyState),4===m.readyState){localStorage.removeItem(n.name);var e;200===m.status?(e=m.responseText,logger.debug("mkfile is success: ",e),s(r,n,e)):(e={status:m.status,response:m.responseText,file:n,code:-200},logger.debug("mkfile is error: ",e),l.trigger("Error",e))}};v&&v<=9?m.bind("readystatechange",b):m.onreadystatechange=b,m.send(o),logger.debug("mkfile: ",_)}else s(r,n,a.response)}}(s)),logger.debug("bind FileUploaded event"),l.init(),logger.debug("invoke uploader.init()"),logger.debug("init uploader end"),l},this.getUrl=function(e){if(!e)return!1;e=encodeURI(e);var t=this.domain;return"/"!==t.slice(t.length-1)&&(t+="/"),t+e},this.imageView2=function(e,t){var r=e.mode||"",i=e.w||"",n=e.h||"",a=e.q||"",s=e.format||"";if(!r)return!1;if(!i&&!n)return!1;var o="imageView2/"+r;return o+=i?"/w/"+i:"",o+=n?"/h/"+n:"",o+=a?"/q/"+a:"",o+=s?"/format/"+s:"",t&&(o=this.getUrl(t)+"?"+o),o},this.imageMogr2=function(e,t){var r=e["auto-orient"]||"",i=e.thumbnail||"",n=e.strip||"",a=e.gravity||"",s=e.crop||"",o=e.quality||"",u=e.rotate||"",l=e.format||"",d=e.blur||"",g="imageMogr2";return g+=r?"/auto-orient":"",g+=i?"/thumbnail/"+i:"",g+=n?"/strip":"",g+=a?"/gravity/"+a:"",g+=o?"/quality/"+o:"",g+=s?"/crop/"+s:"",g+=u?"/rotate/"+u:"",g+=l?"/format/"+l:"",g+=d?"/blur/"+d:"",t&&(g=this.getUrl(t)+"?"+g),g},this.watermark=function(e,t){var r=e.mode;if(!r)return!1;var i="watermark/"+r;if(1===r){var n=e.image||"";if(!n)return!1;i+=n?"/image/"+this.URLSafeBase64Encode(n):""}else{if(2!==r)return!1;var a=e.text?e.text:"",s=e.font?e.font:"",o=e.fontsize?e.fontsize:"",u=e.fill?e.fill:"";if(!a)return!1;i+=a?"/text/"+this.URLSafeBase64Encode(a):"",i+=s?"/font/"+this.URLSafeBase64Encode(s):"",i+=o?"/fontsize/"+o:"",i+=u?"/fill/"+this.URLSafeBase64Encode(u):""}var l=e.dissolve||"",d=e.gravity||"",g=e.dx||"",c=e.dy||"";return i+=l?"/dissolve/"+l:"",i+=d?"/gravity/"+d:"",i+=g?"/dx/"+g:"",i+=c?"/dy/"+c:"",t&&(i=this.getUrl(t)+"?"+i),i},this.imageInfo=function(e){if(!e)return!1;var t,r=this.getUrl(e)+"?imageInfo",i=this.createAjax(),n=this;return i.open("GET",r,!1),i.onreadystatechange=function(){4===i.readyState&&200===i.status&&(t=n.parseJSON(i.responseText))},i.send(),t},this.exif=function(e){if(!e)return!1;var t,r=this.getUrl(e)+"?exif",i=this.createAjax(),n=this;return i.open("GET",r,!1),i.onreadystatechange=function(){4===i.readyState&&200===i.status&&(t=n.parseJSON(i.responseText))},i.send(),t},this.get=function(e,t){return!(!t||!e)&&("exif"===e?this.exif(t):"imageInfo"===e&&this.imageInfo(t))},this.pipeline=function(e,t){
var r,i,n="[object Array]"===Object.prototype.toString.call(e),a="";if(n){for(var s=0,o=e.length;s<o;s++){if(r=e[s],!r.fop)return!1;switch(r.fop){case"watermark":a+=this.watermark(r)+"|";break;case"imageView2":a+=this.imageView2(r)+"|";break;case"imageMogr2":a+=this.imageMogr2(r)+"|";break;default:i=!0}if(i)return!1}if(t){a=this.getUrl(t)+"?"+a;var u=a.length;"|"===a.slice(u-1)&&(a=a.slice(0,u-1))}return a}return!1}}window.localStorage||(window.localStorage={setItem:function(e,t){createCookie(e,t,30)},getItem:function(e){return readCookie(e)},removeItem:function(e){createCookie(e,"",-1)}});var Qiniu=new QiniuJsSDK;global.Qiniu=Qiniu,global.QiniuJsSDK=QiniuJsSDK}(window);